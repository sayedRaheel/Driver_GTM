<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver GTM - Driver to Load Matching</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .search-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .search-section h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            margin-top: 30px;
        }

        .drivers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .driver-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .driver-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .driver-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .driver-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .driver-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            color: #666;
            font-size: 0.9em;
        }

        .driver-info-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .driver-info-label {
            font-weight: 600;
            color: #555;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-equipment {
            background: #667eea;
            color: white;
        }

        .badge-dot {
            background: #10b981;
            color: white;
            font-size: 0.8em;
        }

        .badge-mc {
            background: #f59e0b;
            color: white;
            font-size: 0.8em;
        }

        .service-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 500;
            margin-right: 4px;
            margin-bottom: 2px;
        }

        .service-badge.bookable {
            background: #dbeafe;
            color: #1e40af;
        }

        .service-badge.negotiable {
            background: #fef3c7;
            color: #92400e;
        }

        .service-badge.factorable {
            background: #dcfce7;
            color: #166534;
        }

        .service-badge.trackable {
            background: #fce7f3;
            color: #be185d;
        }

        .service-badge.assurable {
            background: #e0e7ff;
            color: #3730a3;
        }

        .driver-details {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .driver-details h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .detail-label {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #333;
            font-size: 1.1em;
        }

        .loads-section {
            margin-top: 30px;
        }

        .load-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }

        .load-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .load-route {
            flex: 1;
        }

        .load-route h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .route-details {
            color: #666;
            font-size: 1em;
        }

        .load-score {
            text-align: right;
        }

        .score-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .score-green { color: #10b981; }
        .score-yellow { color: #f59e0b; }
        .score-orange { color: #f97316; }
        .score-red { color: #ef4444; }

        .score-label {
            font-size: 0.9em;
            font-weight: 600;
        }

        .load-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
        }

        .load-broker {
            padding: 15px;
            background: #f0f4ff;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .broker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .broker-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .broker-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
        }

        .broker-value {
            color: #333;
            font-size: 1em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc2626;
            margin: 20px 0;
        }

        .info-message {
            background: #dbeafe;
            color: #1e40af;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            margin: 20px 0;
        }

        .hidden {
            display: none !important;
        }

        /* Raw Data Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: #667eea;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3em;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 120px);
        }

        .raw-data-section {
            margin-bottom: 20px;
        }

        .raw-data-section h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }

        .json-display {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85em;
            line-height: 1.4;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
            margin: 5px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .load-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
        }

        .pickup-window {
            background: rgba(102, 126, 234, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            margin-top: 8px;
        }

        .pickup-window div:first-child {
            font-size: 0.8em;
            margin-bottom: 4px;
        }

        .pickup-window div:last-child {
            font-size: 0.85em;
            font-weight: 500;
            color: #333;
        }

        .email-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .email-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöö Driver GTM</h1>
            <p>Find the best loads for available drivers using efRouting intelligence</p>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <h2>üîç Search for Drivers</h2>

            <!-- Environment Selector -->
            <div style="background: #f0f4ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                <div class="form-group" style="margin: 0;">
                    <label for="environment" style="font-weight: 700; color: #667eea; margin-bottom: 8px;">üåç DAT Environment</label>
                    <select id="environment" style="font-weight: 600; border-color: #667eea;">
                        <option value="staging" selected>Staging (Test Data)</option>
                        <option value="production">Production (Live Data)</option>
                    </select>
                    <small style="color: #666; margin-top: 5px; display: block;">For production, you need valid production credentials in backend .env file</small>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="origin_state">Origin State *</label>
                    <select id="origin_state" required>
                        <option value="">Select State</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="origin_city">Origin City (Optional)</label>
                    <input type="text" id="origin_city" placeholder="e.g., Houston">
                </div>
                <div class="form-group">
                    <label for="equipment_type">Equipment Type *</label>
                    <select id="equipment_type" required>
                        <option value="V">Van</option>
                        <option value="R">Reefer</option>
                        <option value="F">Flatbed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="load_type">Load Type Filter</label>
                    <select id="load_type">
                        <option value="">All Load Types</option>
                        <option value="FULL">Full Loads Only</option>
                        <option value="PARTIAL">Partial Loads Only</option>
                        <option value="BOTH">Both Full & Partial</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="max_deadhead">Max Deadhead (miles)</label>
                    <input type="number" id="max_deadhead" value="50" min="0" max="500">
                </div>
                <div class="form-group">
                    <label for="environment">Environment</label>
                    <select id="environment" onchange="toggleCredentials()">
                        <option value="staging">Staging</option>
                        <option value="production">Production</option>
                    </select>
                </div>
                
                <!-- Production Credentials Section (Hidden by default) -->
                <div id="production-credentials" class="form-group" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; grid-column: 1 / -1;">
                    <h4 style="margin-bottom: 15px; color: #dc2626;">üîê Production Credentials</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="prod_username">Production Username</label>
                            <input type="email" id="prod_username" placeholder="your_production_username@company.com">
                        </div>
                        <div class="form-group">
                            <label for="prod_password">Production Password</label>
                            <input type="password" id="prod_password" placeholder="your_production_password">
                        </div>
                        <div class="form-group">
                            <label for="prod_user">Production User Email</label>
                            <input type="email" id="prod_user" placeholder="your_production_user@company.com">
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="searchDrivers()">
                üîç Search Drivers
            </button>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <!-- Loading Indicator -->
            <div id="loading" class="loading hidden">
                <div class="loading-spinner"></div>
                <p style="margin-top: 15px; color: #666;">Searching for drivers...</p>
            </div>

            <!-- Error Message -->
            <div id="error" class="error-message hidden"></div>

            <!-- Drivers Grid -->
            <div id="drivers-container" class="hidden">
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); margin-bottom: 20px;">
                    <h2 style="color: #333; margin-bottom: 10px;">üìã Available Drivers</h2>
                    <p id="driver-count" style="color: #666;"></p>
                </div>
                <div id="drivers-grid" class="drivers-grid"></div>
            </div>

            <!-- Selected Driver Details -->
            <div id="driver-details-container" class="hidden">
                <div class="driver-details">
                    <h2>üë§ Driver Details</h2>
                    <div id="driver-details" class="detail-grid"></div>
                </div>

                <!-- Loading Loads -->
                <div id="loads-loading" class="loading">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 15px; color: #666;">Finding best loads using KAYAAN Profit Score...</p>
                </div>

                <!-- Loads Section -->
                <div id="loads-container" class="hidden">
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); margin-bottom: 20px;">
                        <h2 style="color: #667eea; margin-bottom: 10px;">üéØ Best Loads (Ranked by KAYAAN Profit Score)</h2>
                        <p id="loads-count" style="color: #666;"></p>
                    </div>
                    <div id="loads-list"></div>
                </div>

                <!-- No Loads Message -->
                <div id="no-loads" class="info-message hidden">
                    No loads found for this driver location.
                </div>
            </div>
        </div>
    </div>

    <!-- Raw Data Modal -->
    <div id="rawDataModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîç Raw Load Data</h3>
                <button class="modal-close" onclick="closeRawDataModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="rawDataContent"></div>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>üìß Driver Email Template</h3>
                <button class="modal-close" onclick="closeEmailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="copyEmailToClipboard()" style="margin-bottom: 15px;">
                        üìã Copy Email to Clipboard
                    </button>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                        <strong>Instructions:</strong> Copy this email template and send it to the driver. They can contact the broker directly using the provided information.
                    </div>
                </div>
                <div id="emailContent" style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; font-family: Arial, sans-serif; line-height: 1.6; white-space: pre-wrap;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5004/api';
        let currentSelectedDriver = null;

        // Load states on page load
        window.onload = function() {
            loadStates();
        };

        // Toggle production credentials visibility
        function toggleCredentials() {
            const environment = document.getElementById('environment').value;
            const credentialsDiv = document.getElementById('production-credentials');
            
            if (environment === 'production') {
                credentialsDiv.style.display = 'block';
            } else {
                credentialsDiv.style.display = 'none';
                // Clear credentials when switching back to staging
                document.getElementById('prod_username').value = '';
                document.getElementById('prod_password').value = '';
                document.getElementById('prod_user').value = '';
            }
        }

        async function loadStates() {
            try {
                const response = await fetch(`${API_URL}/states`);
                const data = await response.json();

                const select = document.getElementById('origin_state');
                data.states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading states:', error);
            }
        }

        async function searchDrivers() {
            const origin_state = document.getElementById('origin_state').value;
            const origin_city = document.getElementById('origin_city').value;
            const equipment_type = document.getElementById('equipment_type').value;
            const max_deadhead = document.getElementById('max_deadhead').value;
            const environment = document.getElementById('environment').value;

            if (!origin_state) {
                showError('Please select an origin state');
                return;
            }

            // Get production credentials if production is selected
            let productionCredentials = null;
            if (environment === 'production') {
                const username = document.getElementById('prod_username').value;
                const password = document.getElementById('prod_password').value;
                const user = document.getElementById('prod_user').value;
                
                if (!username || !password || !user) {
                    showError('Production credentials are required when using Production environment. Please fill in all credential fields.');
                    return;
                }
                
                productionCredentials = {
                    username: username,
                    password: password,
                    user: user
                };
            }

            // Show loading
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('drivers-container').classList.add('hidden');
            document.getElementById('driver-details-container').classList.add('hidden');

            try {
                // Use a reasonable limit - DAT API has a maximum limit around 200
                // Using 150 to be safe, then we filter to only show companies with ‚â§10 trucks
                const searchLimit = 150;  // Safe limit that works with DAT API
                
                // Create abort controller for timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 120 seconds timeout
                
                const response = await fetch(`${API_URL}/search-drivers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        origin_state,
                        origin_city: origin_city || null,
                        equipment_types: [equipment_type],
                        filters: {
                            max_deadhead: parseInt(max_deadhead)
                        },
                        limit: searchLimit,  // Reasonable limit to get drivers, then filter by truck count (‚â§10 trucks)
                        environment: environment,
                        production_credentials: productionCredentials
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                const data = await response.json();

                if (!response.ok) {
                    const errorMsg = data.error || `HTTP ${response.status}: ${response.statusText}`;
                    console.error('Backend error:', errorMsg);
                    throw new Error(errorMsg);
                }

                // Check if data has drivers array
                if (!data.drivers || !Array.isArray(data.drivers)) {
                    console.error('Invalid response format:', data);
                    throw new Error('Invalid response from server. Please try again.');
                }

                // Hide loading
                document.getElementById('loading').classList.add('hidden');

                if (!data.drivers || data.drivers.length === 0) {
                    // Check if it's actually an error or just no results
                    const msg = data.total_count > 0 
                        ? `No drivers found matching your criteria (companies with ‚â§10 trucks). ${data.total_count} drivers found but all filtered out. Try adjusting your search criteria.`
                        : 'No drivers found matching your criteria. Try adjusting your search criteria or search location.';
                    showError(msg);
                    document.getElementById('drivers-container').classList.add('hidden');
                    return;
                }

                // Display drivers
                displayDrivers(data.drivers, data.total_count);

            } catch (error) {
                console.error('Error searching drivers:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                document.getElementById('loading').classList.add('hidden');
                
                // Show detailed error message
                let errorMsg = error.message || 'Failed to search drivers';
                if (error.name === 'AbortError' || error.message.includes('aborted')) {
                    errorMsg = 'Request timed out. The search is taking too long. Try reducing your search area or contact support.';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg = 'Network error: Could not connect to server. Please check if the backend is running.';
                } else if (error.message.includes('Invalid response')) {
                    errorMsg = 'Server returned invalid data. Please try again.';
                }
                
                showError(errorMsg);
            }
        }

        function displayDrivers(drivers, totalCount) {
            const container = document.getElementById('drivers-container');
            const grid = document.getElementById('drivers-grid');
            const countEl = document.getElementById('driver-count');

            grid.innerHTML = '';
            countEl.textContent = `Found ${totalCount} drivers, showing top ${drivers.length}`;

            drivers.forEach(driver => {
                const card = createDriverCard(driver);
                grid.appendChild(card);
            });

            container.classList.remove('hidden');
        }

        function createDriverCard(driver) {
            const card = document.createElement('div');
            card.className = 'driver-card';
            card.onclick = () => selectDriver(driver, card);

            const equipmentTypes = {
                'V': 'Van',
                'R': 'Reefer',
                'F': 'Flatbed'
            };

            card.innerHTML = `
                <h3>
                    üöõ ${driver.company_name}
                </h3>
                <div class="driver-info">
                    <div class="driver-info-row">
                        <span class="badge badge-equipment">${equipmentTypes[driver.equipment_type] || driver.equipment_type}</span>
                        ${driver.credentials?.dot_number && driver.credentials.dot_number !== 'N/A' ? `<span class="badge badge-dot">DOT: ${driver.credentials.dot_number}</span>` : ''}
                        ${driver.credentials?.mc_number && driver.credentials.mc_number !== 'N/A' ? `<span class="badge badge-mc">MC: ${driver.credentials.mc_number}</span>` : ''}
                    </div>
                    <div class="driver-info-row">
                        <span class="driver-info-label">üìç Location:</span>
                        ${driver.location.city}, ${driver.location.state}
                    </div>
                    <div class="driver-info-row">
                        <span class="driver-info-label">üìÖ Available:</span>
                        ${formatDate(driver.availability.earliest)}
                    </div>
                    <div class="driver-info-row">
                        <span class="driver-info-label">üéØ Destination:</span>
                        ${driver.destination.state || 'Open'}
                    </div>
                    <div class="driver-info-row">
                        <span class="driver-info-label">üìû Phone:</span>
                        ${driver.contact.phone}
                    </div>
                    <div class="driver-info-row">
                        <span class="driver-info-label">üöõ Capacity:</span>
                        ${driver.capacity?.length_feet && driver.capacity.length_feet !== 'N/A' ? `${driver.capacity.length_feet}ft` : 'N/A'} √ó 
                        ${driver.capacity?.weight_pounds && driver.capacity.weight_pounds !== 'N/A' ? `${(driver.capacity.weight_pounds).toLocaleString()}lbs` : 'N/A'}
                    </div>
                    <div class="driver-info-row">
                        <span class="driver-info-label">üöö Number of Trucks:</span>
                        ${driver.usdot_data && driver.usdot_data.truck_units !== null && driver.usdot_data.truck_units !== undefined ? `<strong style="color: #22c55e; font-size: 1.1em;">${driver.usdot_data.truck_units}</strong>` : '<span style="color: #999;">N/A</span>'}
                    </div>
                    <div class="driver-info-row">
                        <span class="driver-info-label">üë• Total Drivers:</span>
                        ${driver.usdot_data && driver.usdot_data.total_drivers !== null && driver.usdot_data.total_drivers !== undefined ? `<strong style="color: #22c55e; font-size: 1.1em;">${driver.usdot_data.total_drivers}</strong>` : '<span style="color: #999;">N/A</span>'}
                    </div>
                    <div class="driver-info-row">
                        <span class="driver-info-label">‚ö° Services:</span>
                        ${driver.service_flags?.is_bookable ? '<span class="service-badge bookable">Bookable</span>' : ''}
                        ${driver.service_flags?.is_negotiable ? '<span class="service-badge negotiable">Negotiable</span>' : ''}
                        ${driver.service_flags?.is_factorable ? '<span class="service-badge factorable">Factorable</span>' : ''}
                        ${driver.service_flags?.is_trackable ? '<span class="service-badge trackable">Trackable</span>' : ''}
                    </div>
                </div>
            `;

            return card;
        }

        async function selectDriver(driver, cardElement) {
            // Update UI
            document.querySelectorAll('.driver-card').forEach(c => c.classList.remove('selected'));
            cardElement.classList.add('selected');

            currentSelectedDriver = driver;

            // Show driver details
            displayDriverDetails(driver);

            // Show loading for loads
            document.getElementById('driver-details-container').classList.remove('hidden');
            document.getElementById('loads-loading').classList.remove('hidden');
            document.getElementById('loads-container').classList.add('hidden');
            document.getElementById('no-loads').classList.add('hidden');

            // Fetch loads for driver
            await fetchLoadsForDriver(driver);
        }

        function displayDriverDetails(driver) {
            const detailsEl = document.getElementById('driver-details');

            // Format USDOT data section
            const usdotInfo = driver.usdot_data ? `
                <div class="detail-item" style="grid-column: 1 / -1; background: #f0fdf4; padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #22c55e;">
                    <h4 style="margin-bottom: 15px; color: #22c55e;">üè¢ USDOT Registry Information</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <div class="detail-item">
                            <div class="detail-label">Legal Name</div>
                            <div class="detail-value">${driver.usdot_data.legal_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Number of Trucks</div>
                            <div class="detail-value">${driver.usdot_data.truck_units !== null && driver.usdot_data.truck_units !== undefined ? driver.usdot_data.truck_units : 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Drivers</div>
                            <div class="detail-value">${driver.usdot_data.total_drivers !== null && driver.usdot_data.total_drivers !== undefined ? driver.usdot_data.total_drivers : 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">USDOT MC Number</div>
                            <div class="detail-value">${driver.usdot_data.mc_number || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Physical City</div>
                            <div class="detail-value">${driver.usdot_data.phy_city || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Physical State</div>
                            <div class="detail-value">${driver.usdot_data.phy_state || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Entity Type</div>
                            <div class="detail-value">${driver.usdot_data.entity_type || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            ` : '';

            detailsEl.innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">Company</div>
                    <div class="detail-value">${driver.company_name}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Equipment Type</div>
                    <div class="detail-value">${driver.equipment_type}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">DOT Number</div>
                    <div class="detail-value">${driver.credentials?.dot_number && driver.credentials.dot_number !== 'N/A' ? driver.credentials.dot_number : 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">MC Number (DAT)</div>
                    <div class="detail-value">${driver.credentials?.mc_number && driver.credentials.mc_number !== 'N/A' ? driver.credentials.mc_number : 'N/A'}</div>
                </div>
                <div class="detail-item" style="background: #f0fdf4; border-left: 4px solid #22c55e;">
                    <div class="detail-label">üöö Number of Trucks</div>
                    <div class="detail-value" style="font-weight: 700; font-size: 1.2em; color: #22c55e;">
                        ${driver.usdot_data && driver.usdot_data.truck_units !== null && driver.usdot_data.truck_units !== undefined ? driver.usdot_data.truck_units : '<span style="color: #999; font-weight: normal; font-size: 1em;">N/A</span>'}
                    </div>
                </div>
                <div class="detail-item" style="background: #f0fdf4; border-left: 4px solid #22c55e;">
                    <div class="detail-label">üë• Total Drivers</div>
                    <div class="detail-value" style="font-weight: 700; font-size: 1.2em; color: #22c55e;">
                        ${driver.usdot_data && driver.usdot_data.total_drivers !== null && driver.usdot_data.total_drivers !== undefined ? driver.usdot_data.total_drivers : '<span style="color: #999; font-weight: normal; font-size: 1em;">N/A</span>'}
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Current Location</div>
                    <div class="detail-value">${driver.location.city}, ${driver.location.state}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Carrier Home State</div>
                    <div class="detail-value">${driver.carrier_home_state && driver.carrier_home_state !== 'N/A' ? driver.carrier_home_state : 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Availability Start</div>
                    <div class="detail-value">${formatDate(driver.availability.earliest)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Availability End</div>
                    <div class="detail-value">${driver.availability.latest && driver.availability.latest !== 'N/A' ? formatDate(driver.availability.latest) : 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Phone</div>
                    <div class="detail-value">${driver.contact.phone}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">${driver.contact.email}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Preferred Contact Method</div>
                    <div class="detail-value">${driver.preferred_contact_method && driver.preferred_contact_method !== 'N/A' ? driver.preferred_contact_method : 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Preferred Destination</div>
                    <div class="detail-value">${driver.destination.state || 'Open'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Deadhead</div>
                    <div class="detail-value">${driver.deadhead} miles</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Truck Length</div>
                    <div class="detail-value">${driver.capacity?.length_feet && driver.capacity.length_feet !== 'N/A' ? driver.capacity.length_feet + ' ft' : 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Weight Capacity</div>
                    <div class="detail-value">${driver.capacity?.weight_pounds && driver.capacity.weight_pounds !== 'N/A' ? (driver.capacity.weight_pounds).toLocaleString() + ' lbs' : 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Posting ID</div>
                    <div class="detail-value">${driver.posting_id && driver.posting_id !== 'N/A' ? driver.posting_id : 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Posting Expires</div>
                    <div class="detail-value">${driver.posting_expires && driver.posting_expires !== 'N/A' ? formatDate(driver.posting_expires) : 'N/A'}</div>
                </div>
                <div class="detail-item" style="grid-column: 1 / -1;">
                    <div class="detail-label">Driver Comments</div>
                    <div class="detail-value">${driver.comments && driver.comments !== 'N/A' ? driver.comments : 'No comments'}</div>
                </div>
                <div class="detail-item" style="grid-column: 1 / -1;">
                    <div class="detail-label">Available Services</div>
                    <div class="detail-value">
                        ${driver.service_flags?.is_bookable ? '<span class="service-badge bookable">Bookable</span>' : ''}
                        ${driver.service_flags?.is_negotiable ? '<span class="service-badge negotiable">Negotiable</span>' : ''}
                        ${driver.service_flags?.is_factorable ? '<span class="service-badge factorable">Factorable</span>' : ''}
                        ${driver.service_flags?.is_assurable ? '<span class="service-badge assurable">Assurable</span>' : ''}
                        ${driver.service_flags?.is_trackable ? '<span class="service-badge trackable">Trackable</span>' : ''}
                        ${!driver.service_flags?.is_bookable && !driver.service_flags?.is_negotiable && !driver.service_flags?.is_factorable && !driver.service_flags?.is_assurable && !driver.service_flags?.is_trackable ? 'No special services available' : ''}
                    </div>
                </div>
                ${usdotInfo}
                <div class="detail-item" style="grid-column: 1 / -1; text-align: center; padding-top: 20px;">
                    <button class="btn btn-secondary btn-small" onclick="showRawDriverData(${JSON.stringify(driver).replace(/"/g, '&quot;')})">
                        üîç View Raw Driver Data
                    </button>
                </div>
            `;
        }

        async function fetchLoadsForDriver(driver) {
            const environment = document.getElementById('environment').value;

            // Validate driver has valid city information
            if (!driver.location.city || driver.location.city === 'N/A' || driver.location.city.trim() === '') {
                document.getElementById('loads-loading').classList.add('hidden');
                showError(`Cannot search loads: Driver location city is missing or invalid. Driver is in ${driver.location.state} but specific city is not available.`);
                return;
            }

            // Get production credentials if production is selected
            let productionCredentials = null;
            if (environment === 'production') {
                const username = document.getElementById('prod_username').value;
                const password = document.getElementById('prod_password').value;
                const user = document.getElementById('prod_user').value;
                
                if (!username || !password || !user) {
                    document.getElementById('loads-loading').classList.add('hidden');
                    showError('Production credentials are required when using Production environment. Please fill in all credential fields.');
                    return;
                }
                
                productionCredentials = {
                    username: username,
                    password: password,
                    user: user
                };
            }

            try {
                const response = await fetch(`${API_URL}/get-loads-for-driver`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        driver_location_city: driver.location.city,
                        driver_location_state: driver.location.state,
                        equipment_type: driver.equipment_type,
                        driver_availability: driver.availability,
                        filters: {
                            load_type: document.getElementById('load_type').value
                        },
                        limit: 50,
                        environment: environment,
                        production_credentials: productionCredentials
                    })
                });

                const data = await response.json();

                // Hide loading
                document.getElementById('loads-loading').classList.add('hidden');

                if (!response.ok) {
                    // Show detailed error message if available
                    const errorMessage = data.message || data.error || 'Failed to fetch loads';
                    throw new Error(errorMessage);
                }

                if (data.loads.length === 0) {
                    document.getElementById('no-loads').classList.remove('hidden');
                    return;
                }

                // Display loads
                displayLoads(data.loads);

            } catch (error) {
                console.error('Error fetching loads:', error);
                document.getElementById('loads-loading').classList.add('hidden');
                showError(`Failed to load loads: ${error.message}`);
            }
        }

        function displayLoads(loads) {
            const container = document.getElementById('loads-container');
            const list = document.getElementById('loads-list');
            const countEl = document.getElementById('loads-count');

            list.innerHTML = '';
            countEl.textContent = `Found ${loads.length} loads, ranked by KAYAAN Profit Score`;

            console.log('Displaying loads:', loads.length, 'loads');

            loads.forEach((load, index) => {
                console.log(`Creating card for load ${index + 1}:`, load);
                const card = createLoadCard(load, index + 1);
                list.appendChild(card);
            });

            container.classList.remove('hidden');
        }

        function createLoadCard(load, rank) {
            try {
                const card = document.createElement('div');
                card.className = 'load-card';

                const score = load.composite_data?.composite_score || 0;
                const scoreColor = getScoreColor(score);
                const recommendation = load.composite_data?.recommendation || 'Unknown';

                // Check if rate is available or estimated
                const rateDisplay = (load.profit_data?.rate_per_mile || 0) > 0
                    ? `$${(load.profit_data?.rate_per_mile || 0).toFixed(2)}/mi`
                    : 'Rate Not Available';

            card.innerHTML = `
                <div class="load-header">
                    <div class="load-route">
                        <h3>#${rank} ${load.origin.city}, ${load.origin.state} ‚Üí ${load.destination.city}, ${load.destination.state}</h3>
                        <div class="route-details">
                            ${load.profit_data?.trip_miles || 'N/A'} miles | ${load.profit_data?.equipment_type || 'N/A'} | ${load.broker_info?.company_name || 'N/A'}
                        </div>
                    </div>
                    <div class="load-score">
                        <div class="score-value score-${scoreColor}">${score}</div>
                        <div class="score-label">${recommendation}</div>
                        <div class="pickup-window">
                            <div>üìÖ Pickup Window</div>
                            <div>${formatPickupWindow(load.availability)}</div>
                        </div>
                    </div>
                </div>

                <!-- Pickup & Delivery Information -->
                <div class="load-broker" style="margin-bottom: 15px; background: #f0f9ff; border-left-color: #0ea5e9;">
                    <h4 style="margin-bottom: 15px; color: #0ea5e9;">üöõ Pickup & Delivery Details</h4>
                    <div class="broker-grid">
                        <div class="broker-item">
                            <div class="broker-label">Pickup Location</div>
                            <div class="broker-value">${load.origin?.city || 'N/A'}, ${load.origin?.state || 'N/A'}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Drop-off Location</div>
                            <div class="broker-value">${load.destination?.city || 'N/A'}, ${load.destination?.state || 'N/A'}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Pickup Window</div>
                            <div class="broker-value">${formatPickupWindow(load.availability)}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Distance</div>
                            <div class="broker-value">${load.profit_data?.trip_miles || 'N/A'} miles</div>
                        </div>
                    </div>
                </div>

                <!-- Load Details -->
                <div class="load-broker" style="margin-bottom: 15px; background: #f0fdf4; border-left-color: #22c55e;">
                    <h4 style="margin-bottom: 15px; color: #22c55e;">üì¶ Load Details</h4>
                    <div class="broker-grid">
                        <div class="broker-item">
                            <div class="broker-label">Weight</div>
                            <div class="broker-value">${load.load_details?.weight_pounds ? (load.load_details.weight_pounds).toLocaleString() + ' lbs' : 'N/A'}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Length</div>
                            <div class="broker-value">${load.load_details?.length_feet || 'N/A'} ft</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Load Type</div>
                            <div class="broker-value">${load.load_details?.full_partial || 'N/A'}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Commodity</div>
                            <div class="broker-value">${load.load_details?.commodity || 'N/A'}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Reference ID</div>
                            <div class="broker-value">${load.load_details?.reference_id || 'N/A'}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Equipment Type</div>
                            <div class="broker-value">${load.load_details?.equipment_type || 'N/A'}</div>
                        </div>
                    </div>
                    ${load.load_details?.special_instructions && load.load_details.special_instructions !== 'N/A' ? `
                    <div class="broker-item" style="grid-column: 1 / -1; margin-top: 10px;">
                        <div class="broker-label">‚ö†Ô∏è Special Instructions</div>
                        <div class="broker-value" style="font-style: italic; color: #dc2626;">${load.load_details.special_instructions}</div>
                    </div>
                    ` : ''}
                    ${load.load_details?.comments && load.load_details.comments !== 'N/A' ? `
                    <div class="broker-item" style="grid-column: 1 / -1; margin-top: 10px;">
                        <div class="broker-label">üìù Comments</div>
                        <div class="broker-value" style="font-style: italic;">${load.load_details.comments}</div>
                    </div>
                    ` : ''}
                </div>

                <!-- Main Metrics -->
                <div class="load-metrics">
                    <div class="metric">
                        <div class="metric-value">$${(load.profit_data?.total_revenue || 0).toLocaleString()}</div>
                        <div class="metric-label">Total Revenue</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">$${(load.profit_data?.net_profit || 0).toLocaleString()}</div>
                        <div class="metric-label">Net Profit</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${rateDisplay}</div>
                        <div class="metric-label">Rate Per Mile</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${load.profit_data?.total_miles || 'N/A'}</div>
                        <div class="metric-label">Total Miles</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${load.profit_data?.trip_miles || 'N/A'}</div>
                        <div class="metric-label">Trip Miles</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${load.profit_data?.origin_deadhead || 'N/A'}</div>
                        <div class="metric-label">Deadhead Miles</div>
                    </div>
                </div>

                <!-- Cost Breakdown -->
                <div class="load-broker" style="margin-bottom: 15px;">
                    <h4 style="margin-bottom: 15px; color: #667eea;">üí∞ Cost & Profit Breakdown</h4>
                    <div class="broker-grid">
                        <div class="broker-item">
                            <div class="broker-label">Fuel Cost</div>
                            <div class="broker-value">$${(load.profit_data?.fuel_cost || 0).toFixed(2)}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Operations Cost</div>
                            <div class="broker-value">$${(load.profit_data?.ops_cost || 0).toFixed(2)}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Total Costs</div>
                            <div class="broker-value">$${(load.profit_data?.total_costs || 0).toFixed(2)}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Profit Per Mile</div>
                            <div class="broker-value">$${(load.profit_data?.profit_per_mile || 0).toFixed(2)}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Profit Score</div>
                            <div class="broker-value">${load.composite_data?.individual_scores?.profit || 'N/A'}/100</div>
                        </div>
                    </div>
                </div>

                <!-- Market Data -->
                <div class="load-broker" style="margin-bottom: 15px;">
                    <h4 style="margin-bottom: 15px; color: #667eea;">üìä Market Analysis</h4>
                    <div class="broker-grid">
                        <div class="broker-item">
                            <div class="broker-label">Destination</div>
                            <div class="broker-value">${load.destination.city}, ${load.destination.state}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Outbound Loads</div>
                            <div class="broker-value">${load.market_data?.outbound_loads || 'N/A'}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Available Trucks</div>
                            <div class="broker-value">${load.market_data?.available_trucks || 'N/A'}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Supply/Demand Ratio</div>
                            <div class="broker-value">${load.market_data?.supply_demand_ratio || 'N/A'}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Ease of Booking</div>
                            <div class="broker-value">${load.market_data?.ease_of_booking?.rating || 'N/A'} (${load.market_data?.ease_of_booking?.score || 'N/A'}/100)</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Lane Connectivity</div>
                            <div class="broker-value">${load.market_data?.lane_connectivity?.rating || 'N/A'} (${load.market_data?.lane_connectivity?.score || 'N/A'}/100)</div>
                        </div>
                    </div>
                </div>

                <!-- KAYAAN Profit Scores -->
                <div class="load-broker" style="margin-bottom: 15px; background: #f0fdf4; border-left-color: #10b981;">
                    <h4 style="margin-bottom: 15px; color: #10b981;">üéØ KAYAAN Profit Scores</h4>
                    <div class="broker-grid">
                        <div class="broker-item">
                            <div class="broker-label">Profit Score</div>
                            <div class="broker-value">${load.composite_data?.individual_scores?.profit || 'N/A'}/100 (50% weight)</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Connectivity Score</div>
                            <div class="broker-value">${load.composite_data?.individual_scores?.connectivity || 'N/A'}/100 (30% weight)</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Ease Score</div>
                            <div class="broker-value">${load.composite_data?.individual_scores?.ease || 'N/A'}/100 (20% weight)</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Final Composite</div>
                            <div class="broker-value" style="font-weight: 700; color: #10b981; font-size: 1.2em;">${score}/100</div>
                        </div>
                    </div>
                </div>

                <!-- Broker Information -->
                <div class="load-broker">
                    <h4 style="margin-bottom: 15px; color: #667eea;">üè¢ Broker Information</h4>
                    <div class="broker-grid">
                        <div class="broker-item">
                            <div class="broker-label">Company</div>
                            <div class="broker-value">${load.broker_info?.company_name || 'N/A'}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Phone</div>
                            <div class="broker-value">${load.broker_info?.phone || 'N/A'}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">MC Number</div>
                            <div class="broker-value">${load.broker_info?.mc_number || 'N/A'}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">DOT Number</div>
                            <div class="broker-value">${load.broker_info?.dot_number || 'N/A'}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Credit Score</div>
                            <div class="broker-value">${load.broker_info?.credit_score || 'N/A'}</div>
                        </div>
                        <div class="broker-item">
                            <div class="broker-label">Days to Pay</div>
                            <div class="broker-value">${load.broker_info?.days_to_pay || 'N/A'}</div>
                        </div>
                        ${load.broker_info?.usdot_data && load.broker_info.usdot_data.truck_units !== null && load.broker_info.usdot_data.truck_units !== undefined ? `
                        <div class="broker-item">
                            <div class="broker-label">üöö Number of Trucks</div>
                            <div class="broker-value" style="font-weight: 600; color: #22c55e;">${load.broker_info.usdot_data.truck_units}</div>
                        </div>
                        ` : ''}
                        ${load.broker_info?.usdot_data && load.broker_info.usdot_data.total_drivers !== null && load.broker_info.usdot_data.total_drivers !== undefined ? `
                        <div class="broker-item">
                            <div class="broker-label">üë• Total Drivers</div>
                            <div class="broker-value" style="font-weight: 600; color: #22c55e;">${load.broker_info.usdot_data.total_drivers}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Load Details -->
                ${load.load_details?.comments && load.load_details.comments !== 'N/A' ? `
                <div class="load-broker" style="margin-top: 15px; background: #fffbeb; border-left-color: #f59e0b;">
                    <h4 style="margin-bottom: 10px; color: #f59e0b;">üìù Load Comments</h4>
                    <p style="color: #333; margin: 0;">${load.load_details.comments}</p>
                </div>
                ` : ''}

                <!-- Load Actions -->
                <div class="load-actions">
                    <button class="btn btn-secondary btn-small" onclick="showRawLoadData(${JSON.stringify(load).replace(/"/g, '&quot;')})">
                        üîç View Raw API Data
                    </button>
                    <button class="btn btn-primary btn-small" onclick="generateDriverEmail(${JSON.stringify(load).replace(/"/g, '&quot;')})">
                        üìß Generate Driver Email
                    </button>
                </div>
            `;

                return card;
            } catch (error) {
                console.error('Error creating load card:', error, load);
                const errorCard = document.createElement('div');
                errorCard.className = 'load-card';
                errorCard.innerHTML = `
                    <div class="load-header">
                        <div class="load-route">
                            <h3>#${rank} Error Loading Load Data</h3>
                            <div class="route-details">
                                Failed to display load information
                            </div>
                        </div>
                    </div>
                    <div class="load-actions">
                        <button class="btn btn-secondary btn-small" onclick="showRawLoadData(${JSON.stringify(load).replace(/"/g, '&quot;')})">
                            üîç View Raw API Data
                        </button>
                    </div>
                `;
                return errorCard;
            }
        }

        function getScoreColor(score) {
            if (score >= 80) return 'green';
            if (score >= 60) return 'yellow';
            if (score >= 40) return 'orange';
            return 'red';
        }

        function formatDate(dateString) {
            if (!dateString || dateString === 'N/A') return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch {
                return dateString;
            }
        }

        function formatPickupWindow(availability) {
            if (!availability) return 'Not specified';
            
            try {
                const earliest = availability.earliestWhen ? new Date(availability.earliestWhen) : null;
                const latest = availability.latestWhen ? new Date(availability.latestWhen) : null;
                
                if (!earliest && !latest) return 'Not specified';
                
                const formatDateTime = (date) => {
                    return date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                };
                
                if (earliest && latest) {
                    // Check if it's the same day
                    const isSameDay = earliest.toDateString() === latest.toDateString();
                    
                    if (isSameDay) {
                        return `${formatDateTime(earliest)} - ${latest.toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit', 
                            hour12: true 
                        })}`;
                    } else {
                        return `${formatDateTime(earliest)} to ${formatDateTime(latest)}`;
                    }
                } else if (earliest) {
                    return `After ${formatDateTime(earliest)}`;
                } else if (latest) {
                    return `Before ${formatDateTime(latest)}`;
                }
                
                return 'Not specified';
            } catch (error) {
                console.error('Error formatting pickup window:', error);
                return 'Invalid date format';
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        function showRawLoadData(loadData) {
            const modal = document.getElementById('rawDataModal');
            const content = document.getElementById('rawDataContent');
            
            // Format the raw data for display
            content.innerHTML = `
                <div class="raw-data-section">
                    <h4>üìä Complete Load Data Structure</h4>
                    <div class="json-display">${JSON.stringify(loadData, null, 2)}</div>
                </div>
                
                <div class="raw-data-section">
                    <h4>üîç Raw DAT API Response</h4>
                    <div class="json-display">${JSON.stringify(loadData.raw_load || {}, null, 2)}</div>
                </div>
                
                <div class="raw-data-section">
                    <h4>üí∞ Profit Analysis Data</h4>
                    <div class="json-display">${JSON.stringify(loadData.profit_data || {}, null, 2)}</div>
                </div>
                
                <div class="raw-data-section">
                    <h4>üìà Market Analysis Data</h4>
                    <div class="json-display">${JSON.stringify(loadData.market_data || {}, null, 2)}</div>
                </div>
                
                <div class="raw-data-section">
                    <h4>üéØ Composite Scoring Data</h4>
                    <div class="json-display">${JSON.stringify(loadData.composite_data || {}, null, 2)}</div>
                </div>
                
                <div class="raw-data-section">
                    <h4>üè¢ Broker Information</h4>
                    <div class="json-display">${JSON.stringify(loadData.broker_info || {}, null, 2)}</div>
                </div>
                
                <div class="raw-data-section">
                    <h4>üìã Load Details</h4>
                    <div class="json-display">${JSON.stringify(loadData.load_details || {}, null, 2)}</div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function showRawDriverData(driverData) {
            const modal = document.getElementById('rawDataModal');
            const content = document.getElementById('rawDataContent');
            
            // Format the raw data for display
            content.innerHTML = `
                <div class="raw-data-section">
                    <h4>üë§ Complete Driver Data Structure</h4>
                    <div class="json-display">${JSON.stringify(driverData, null, 2)}</div>
                </div>
                
                <div class="raw-data-section">
                    <h4>üîç Raw DAT API Response</h4>
                    <div class="json-display">${JSON.stringify(driverData.raw_data || {}, null, 2)}</div>
                </div>
                
                <div class="raw-data-section">
                    <h4>üìç Location Information</h4>
                    <div class="json-display">${JSON.stringify(driverData.location || {}, null, 2)}</div>
                </div>
                
                <div class="raw-data-section">
                    <h4>üìÖ Availability Information</h4>
                    <div class="json-display">${JSON.stringify(driverData.availability || {}, null, 2)}</div>
                </div>
                
                <div class="raw-data-section">
                    <h4>üéØ Destination Information</h4>
                    <div class="json-display">${JSON.stringify(driverData.destination || {}, null, 2)}</div>
                </div>
                
                <div class="raw-data-section">
                    <h4>üìû Contact Information</h4>
                    <div class="json-display">${JSON.stringify(driverData.contact || {}, null, 2)}</div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeRawDataModal() {
            document.getElementById('rawDataModal').classList.add('hidden');
        }

        // Close modal when clicking outside
        document.getElementById('rawDataModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeRawDataModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeRawDataModal();
                closeEmailModal();
            }
        });

        function generateDriverEmail(loadData) {
            const modal = document.getElementById('emailModal');
            const content = document.getElementById('emailContent');
            
            const emailTemplate = createDriverEmailTemplate(loadData);
            content.textContent = emailTemplate;
            
            modal.classList.remove('hidden');
        }

        function createDriverEmailTemplate(load) {
            const pickupWindow = formatPickupWindow(load.availability);
            const currentDate = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            return `Subject: Great Load Opportunity - ${load.origin?.city || 'N/A'}, ${load.origin?.state || 'N/A'} ‚Üí ${load.destination?.city || 'N/A'}, ${load.destination?.state || 'N/A'}

Hi Driver,

Found a profitable load that matches your location and equipment:

üöõ LOAD DETAILS
‚Ä¢ Route: ${load.origin?.city || 'N/A'}, ${load.origin?.state || 'N/A'} ‚Üí ${load.destination?.city || 'N/A'}, ${load.destination?.state || 'N/A'}
‚Ä¢ Distance: ${load.profit_data?.trip_miles || 'N/A'} miles | Equipment: ${load.profit_data?.equipment_type || 'N/A'}
‚Ä¢ Weight: ${load.load_details?.weight_pounds ? (load.load_details.weight_pounds).toLocaleString() + ' lbs' : 'N/A'} | Length: ${load.load_details?.length_feet || 'N/A'} ft
‚Ä¢ Load Type: ${load.load_details?.full_partial || 'N/A'} | Commodity: ${load.load_details?.commodity || 'N/A'}
‚Ä¢ Pickup Window: ${pickupWindow}
‚Ä¢ Load ID: ${load.match_id || 'N/A'} | Reference: ${load.load_details?.reference_id || 'N/A'}
${load.load_details?.special_instructions && load.load_details.special_instructions !== 'N/A' ? `‚Ä¢ Special Instructions: ${load.load_details.special_instructions}` : ''}

üí∞ PROFIT BREAKDOWN
‚Ä¢ Rate: $${(load.profit_data?.rate_per_mile || 0).toFixed(2)}/mile
‚Ä¢ Total Revenue: $${(load.profit_data?.total_revenue || 0).toLocaleString()}
‚Ä¢ NET PROFIT: $${(load.profit_data?.net_profit || 0).toLocaleString()} ($${(load.profit_data?.profit_per_mile || 0).toFixed(2)}/mile)
‚Ä¢ KAYAAN Score: ${load.composite_data?.composite_score || 'N/A'}/100 - ${load.composite_data?.recommendation || 'N/A'}

üìà DESTINATION MARKET
‚Ä¢ ${load.market_data?.outbound_loads || 'N/A'} loads available from ${load.destination?.city || 'N/A'}, ${load.destination?.state || 'N/A'}
‚Ä¢ Market Rating: ${load.market_data?.ease_of_booking?.rating || 'N/A'} (${load.market_data?.supply_demand_ratio || 'N/A'} S/D ratio)
‚Ä¢ High chance of finding your next load quickly

üè¢ BROKER CONTACT
‚Ä¢ Company: ${load.broker_info?.company_name || 'N/A'}
‚Ä¢ Phone: ${load.broker_info?.phone || 'N/A'}
‚Ä¢ MC: ${load.broker_info?.mc_number || 'N/A'} | DOT: ${load.broker_info?.dot_number || 'N/A'}
‚Ä¢ Credit Score: ${load.broker_info?.credit_score || 'N/A'}/100 | Payment: ${load.broker_info?.days_to_pay || 'N/A'} days

üìù NOTES
${load.load_details?.comments && load.load_details.comments !== 'N/A' ? '‚Ä¢ ' + load.load_details.comments : '‚Ä¢ No additional comments'}

üöÄ NEXT STEPS
1. Call broker: ${load.broker_info?.phone || 'N/A'}
2. Mention Load ID: ${load.match_id || 'N/A'}
3. Confirm pickup details and rate

This load shows strong profit potential with excellent market conditions at destination.

Good luck!
KAYAAN Load Matching Team

---
Generated ${currentDate}`;
        }

        function closeEmailModal() {
            document.getElementById('emailModal').classList.add('hidden');
        }

        function copyEmailToClipboard() {
            const emailContent = document.getElementById('emailContent').textContent;
            
            navigator.clipboard.writeText(emailContent).then(function() {
                // Show success message
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copied!';
                button.style.background = '#10b981';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                alert('Failed to copy email. Please select and copy manually.');
            });
        }

        // Close email modal when clicking outside
        document.getElementById('emailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEmailModal();
            }
        });
    </script>
</body>
</html>
